<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebAR - Efek Doppler (Final Debug)</title>
  <!-- A-Frame (dimuat statis, AR.js dimuat dinamis jika diminta) -->
  <script crossorigin="anonymous" src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#f4f6fb}
    #ui {position: absolute; left: 12px; top: 12px; right:12px; z-index: 9999; background: rgba(255,255,255,0.98); border-radius:10px; padding:12px; box-shadow:0 6px 20px rgba(10,20,40,0.08)}
    .row{display:flex;align-items:center;gap:8px;margin:8px 0}
    label{font-size:13px;min-width:140px}
    input[type=range]{flex:1}
    .big{font-size:18px;font-weight:700}
    .small{font-size:12px;color:#444}
    button{padding:8px 10px;border-radius:8px;border:0;background:#2563eb;color:#fff;font-weight:600}
    .btn-danger{background:#ef4444}
    select{padding:6px;border-radius:6px}
    #freqDisplay{font-size:18px}
    footer{font-size:12px;color:#666;margin-top:8px}
    #debugInfo{font-size:12px;color:#666;margin-top:6px}

    /* overlay untuk menampilkan error runtime */
    #errorOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.65);color:#fff;display:none;align-items:center;justify-content:center;z-index:10000;padding:16px}
    #errorOverlay .box{background:#111;padding:18px;border-radius:8px;max-width:900px;max-height:80vh;overflow:auto}
    #errorOverlay pre{white-space:pre-wrap;font-size:13px}

    /* results area for tests */
    #testResults{font-size:13px;margin-top:8px;color:#0b3d91}
  </style>
</head>
<body>
  <div id="ui" role="region" aria-label="Control panel Efek Doppler">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <div class="big">Simulasi Efek Doppler (WebAR)</div>
        <div class="small">Sumber: ikon sirene â€¢ Pengamat: ikon telinga</div>
      </div>
      <div style="text-align:right">
        <div id="freqDisplay">Frekuensi teramati: <strong id="f_obs">â€”</strong> Hz</div>
        <div class="small">(Tekan â–¶ Play untuk mendengar)</div>
      </div>
    </div>

    <div class="row">
      <label for="f_src">Frekuensi sumber (Hz)</label>
      <input id="f_src" type="range" min="100" max="2000" value="440" aria-labelledby="f_src_val">
      <div style="width:82px;text-align:right"><span id="f_src_val">440</span> Hz</div>
    </div>

    <div class="row">
      <label for="v_src">Kecepatan sumber (m/s)</label>
      <input id="v_src" type="range" min="0" max="80" value="0" aria-labelledby="v_src_val">
      <div style="width:82px;text-align:right"><span id="v_src_val">0</span> m/s</div>
    </div>

    <div class="row">
      <label for="v_obs">Kecepatan pengamat (m/s)</label>
      <input id="v_obs" type="range" min="0" max="80" value="0" aria-labelledby="v_obs_val">
      <div style="width:82px;text-align:right"><span id="v_obs_val">0</span> m/s</div>
    </div>

    <div class="row">
      <label for="mode">Mode gerak</label>
      <select id="mode">
        <option value="mendekat">Saling mendekat</option>
        <option value="menjauh">Saling menjauh</option>
      </select>
      <div style="margin-left:auto"><label class="small">v suara (m/s)</label> <input id="v_sound" type="number" value="343" style="width:90px;padding:6px;border-radius:6px;border:1px solid #ccc;text-align:right"></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <button id="playBtn">â–¶ Play suara</button>
      <button id="animateBtn">â–¶ Putar animasi</button>
      <button id="enableArBtn" style="background:#059669">ðŸ”“ Enable AR</button>
      <div style="margin-left:auto" class="small">Buka di perangkat yang mendukung kamera (mobile). Gunakan HTTPS atau localhost.</div>
    </div>

    <div id="debugInfo">Status: siap</div>

    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="triggerJsError" class="btn-danger">âœ– Simulasi JS Error</button>
      <button id="triggerRejection">âš  Simulasi Promise Rejection</button>
      <button id="clearOverlay">âœ“ Clear Overlay</button>
      <button id="runTests" style="background:#0b5ed7">â–¶ Jalankan test otomatis</button>
    </div>

    <div id="testResults" aria-live="polite"></div>

    <footer>Petunjuk: geser slider â€” angka di samping akan berubah real-time, dan frekuensi teramati akan dihitung otomatis.</footer>
  </div>

  <!-- A-Frame scene: fallback 3D (tidak otomatis mengakses kamera) -->
  <a-scene id="aframeScene" embedded vr-mode-ui='enabled: false' renderer='logarithmicDepthBuffer: true;'>
    <a-entity camera></a-entity>
    <a-box id="source" position="-0.6 0 -2" width="0.3" height="0.3" depth="0.2" color="#e11d48"></a-box>
    <a-entity id="sireneIcon" position="-0.6 0.25 -2" text="value: ðŸ”Š Sirene; align: center; width: 2"></a-entity>
    <a-sphere id="observer" position="0.6 0 -1.5" radius="0.18" color="#047857"></a-sphere>
    <a-entity id="earIcon" position="0.6 0.25 -1.5" text="value: ðŸ‘‚ Pengamat; align: center; width: 2"></a-entity>
    <a-entity id="labelAR" position="0 0.7 -1.8" text="value: Frekuensi teramati: - Hz; align: center; width: 4; color: #000"></a-entity>
  </a-scene>

  <!-- Error overlay (will be created lazily if missing) -->
  <script>
    // Safe stringify for various inputs
    function stringifySafe(v){
      try{
        if(typeof v === 'string') return v;
        if(v instanceof Error) return v.stack || v.message || String(v);
        return JSON.stringify(v, Object.getOwnPropertyNames(v), 2);
      }catch(e){
        try{ return String(v); }catch(_) { return 'Unserializable value'; }
      }
    }

    // Ensure overlay exists and return {overlay, pre}
    function ensureOverlay(){
      try{
        let overlay = document.getElementById('errorOverlay');
        if(overlay){
          const pre = overlay.querySelector('#errorText');
          if(pre) return {overlay, pre};
        }
        // create overlay DOM
        overlay = document.createElement('div'); overlay.id = 'errorOverlay';
        overlay.style.display = 'none'; overlay.style.position = 'fixed'; overlay.style.inset = '0';
        overlay.style.background = 'rgba(0,0,0,0.65)'; overlay.style.color = '#fff'; overlay.style.zIndex = '10000'; overlay.style.padding = '16px';
        overlay.style.display = 'flex'; overlay.style.alignItems = 'center'; overlay.style.justifyContent = 'center';

        const box = document.createElement('div'); box.className = 'box';
        box.style.background = '#111'; box.style.padding = '18px'; box.style.borderRadius = '8px'; box.style.maxWidth = '900px'; box.style.maxHeight = '80vh'; box.style.overflow = 'auto';

        const title = document.createElement('strong'); title.textContent = 'Runtime error terdeteksi'; box.appendChild(title);
        const p = document.createElement('p'); p.textContent = 'Jika terjadi error, pesan lengkap ditampilkan di bawah.'; box.appendChild(p);

        const pre = document.createElement('pre'); pre.id = 'errorText'; pre.style.whiteSpace = 'pre-wrap'; pre.style.fontSize = '13px'; pre.textContent = '-'; box.appendChild(pre);

        const close = document.createElement('button'); close.textContent = 'Tutup'; close.style.marginTop = '8px'; close.style.padding = '6px 10px'; close.style.border = 'none'; close.style.background = '#2563eb'; close.style.color = '#fff'; close.style.borderRadius = '6px';
        close.onclick = () => { overlay.style.display = 'none'; };
        box.appendChild(document.createElement('br'));
        box.appendChild(close);

        overlay.appendChild(box);
        document.body.appendChild(overlay);
        return {overlay, pre};
      }catch(e){ try{ console.error('ensureOverlay failed', e); }catch(_){} return null; }
    }

    function showErrorOverlay(msg){
      try{
        const text = stringifySafe(msg);
        const out = ensureOverlay();
        if(!out){ console.error('Could not create overlay, fallback to console:', text); return; }
        out.pre.textContent = text;
        out.overlay.style.display = 'flex';
        console.error('Overlay error shown:', text);
      }catch(e){ try{ console.error('showErrorOverlay failed', e); }catch(_){} }
    }

    // Global handlers
    window.addEventListener('error', (ev) => {
      try{
        const message = ev && ev.message ? ev.message : 'Unknown error';
        const file = ev && ev.filename ? ev.filename : 'n/a';
        const loc = (ev && ev.lineno) ? `${ev.lineno}:${ev.colno || 0}` : 'n/a';
        const stack = (ev && ev.error && ev.error.stack) ? ev.error.stack : (ev && ev.error ? String(ev.error) : 'n/a');
        showErrorOverlay(`Message: ${message}\nFile: ${file}\nLoc: ${loc}\nStack:\n${stack}`);
        ev.preventDefault && ev.preventDefault();
      }catch(e){ console.error('window.error handler failed', e); }
    });

    window.addEventListener('unhandledrejection', (ev) => {
      try{
        const reason = ev && ev.reason ? ev.reason : 'n/a';
        showErrorOverlay('Unhandled promise rejection:\n' + stringifySafe(reason));
        ev.preventDefault && ev.preventDefault();
      }catch(e){ console.error('unhandledrejection handler failed', e); }
    });

    // Main interactive logic
    document.addEventListener('DOMContentLoaded', () => {
      try{
        // Elements
        const fSrc = document.getElementById('f_src');
        const vSrc = document.getElementById('v_src');
        const vObs = document.getElementById('v_obs');
        const fSrcVal = document.getElementById('f_src_val');
        const vSrcVal = document.getElementById('v_src_val');
        const vObsVal = document.getElementById('v_obs_val');
        const mode = document.getElementById('mode');
        const vSoundInput = document.getElementById('v_sound');
        const fObsEl = document.getElementById('f_obs');
        const labelAR = document.getElementById('labelAR');
        const debugInfo = document.getElementById('debugInfo');
        const triggerJsError = document.getElementById('triggerJsError');
        const triggerRejection = document.getElementById('triggerRejection');
        const clearOverlay = document.getElementById('clearOverlay');
        const runTestsBtn = document.getElementById('runTests');
        const testResults = document.getElementById('testResults');

        if(!fSrc || !vSrc || !vObs || !fSrcVal || !vSrcVal || !vObsVal || !mode || !vSoundInput || !fObsEl){
          showErrorOverlay('Inisialisasi gagal: beberapa elemen UI tidak ditemukan.');
          return;
        }

        // update displays
        function updateDisplays(){
          try{
            fSrcVal.textContent = fSrc.value;
            vSrcVal.textContent = vSrc.value;
            vObsVal.textContent = vObs.value;
          }catch(e){ console.warn('updateDisplays error', e); }
        }

        // compute observed frequency using clear sign conventions
        function computeObservedFrequency(frequency, v_sound, v_observer, v_source, modeValue){
          const f = Number(frequency);
          const vs = Number(v_source);
          const vo = Number(v_observer);
          const v = Number(v_sound);
          if(!isFinite(f) || !isFinite(v) || !isFinite(vo) || !isFinite(vs)) return NaN;
          // Determine velocities toward the other party
          const voToward = (modeValue === 'mendekat') ? vo : -vo; // positive if moving toward source
          const vsToward = (modeValue === 'mendekat') ? vs : -vs; // positive if moving toward observer
          const denom = v - vsToward; // v - v_s_toward
          if(denom <= 0) return NaN;
          return f * ((v + voToward) / denom);
        }

        // compute and update UI
        function computeAndUpdate(){
          try{
            const f = Number(fSrc.value);
            const vs = Number(vSrc.value);
            const vo = Number(vObs.value);
            const vSound = Number(vSoundInput.value) || 343;
            const m = mode.value;
            const fObs = computeObservedFrequency(f, vSound, vo, vs, m);
            const fObsRounded = isNaN(fObs) ? 'â€”' : Math.round(fObs*10)/10;
            fObsEl.textContent = fObsRounded;
            debugInfo.textContent = `Last: ${new Date().toLocaleTimeString()} â€” f=${f}Hz, vs=${vs}m/s, vo=${vo}m/s, vSound=${vSound}m/s, mode=${m}, f_obs=${fObsRounded}`;
            // update AR text (safe)
            try{ if(labelAR && labelAR.setAttribute) labelAR.setAttribute('text', `value: Frekuensi teramati: ${fObsRounded} Hz; align: center; width: 4; color: #000`); }catch(e){ console.warn('labelAR update failed', e); }
            return fObs;
          }catch(e){ console.error('computeAndUpdate failed', e); showErrorOverlay('computeAndUpdate error:\n' + stringifySafe(e)); return NaN; }
        }

        // Throttle/RAF scheduling for fluid updates
        let computeScheduled = false;
        function scheduleCompute(){ if(computeScheduled) return; computeScheduled = true; requestAnimationFrame(()=>{ computeScheduled=false; computeAndUpdate(); }); }

        // Attach robust events to sliders
        const inputs = [fSrc, vSrc, vObs, vSoundInput, mode];
        inputs.forEach(el => {
          if(!el) return;
          el.addEventListener('input', () => { updateDisplays(); scheduleCompute(); }, {passive:true});
          el.addEventListener('change', () => { updateDisplays(); scheduleCompute(); });
          el.addEventListener('pointerup', () => { updateDisplays(); scheduleCompute(); });
          el.addEventListener('touchend', () => { updateDisplays(); scheduleCompute(); });
          el.addEventListener('mouseup', () => { updateDisplays(); scheduleCompute(); });
          el.addEventListener('keydown', (ev) => { if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','PageUp','PageDown'].includes(ev.key)){ setTimeout(()=>{ updateDisplays(); scheduleCompute(); }, 0); } });
        });

        // Minimal play/animate/enable AR handlers (safe)
        const playBtn = document.getElementById('playBtn');
        const animateBtn = document.getElementById('animateBtn');
        const enableArBtn = document.getElementById('enableArBtn');
        playBtn && playBtn.addEventListener('click', () => { try{ computeAndUpdate(); alert('Play suara: demo (osilator belum diaktifkan). Hapus alert untuk menghindari gangguan saat pengujian.'); }catch(e){ showErrorOverlay('Play handler error:\n' + stringifySafe(e)); } });
        animateBtn && animateBtn.addEventListener('click', () => { try{ computeAndUpdate(); alert('Animasi: demo.'); }catch(e){ showErrorOverlay('Animate handler error:\n' + stringifySafe(e)); } });
        enableArBtn && enableArBtn.addEventListener('click', () => { try{ const src='https://cdn.jsdelivr.net/npm/ar.js@3.3.2/aframe/build/aframe-ar.min.js'; enableArBtn.disabled=true; enableArBtn.textContent='Memuat AR...'; const s=document.createElement('script'); s.src=src; s.async=true; s.crossOrigin='anonymous'; s.onload=()=>{ alert('AR.js dimuat. Reload halaman untuk mengaktifkan AR.'); location.reload(); }; s.onerror=(e)=>{ showErrorOverlay('Gagal memuat AR.js'); enableArBtn.disabled=false; enableArBtn.textContent='ðŸ”“ Enable AR'; }; document.head.appendChild(s); }catch(e){ showErrorOverlay('Enable AR error:\n' + stringifySafe(e)); } });

        // Debug/test buttons
        triggerJsError && triggerJsError.addEventListener('click', ()=>{ throw new Error('Simulated JS error for testing overlay'); });
        triggerRejection && triggerRejection.addEventListener('click', ()=>{ Promise.reject(new Error('Simulated unhandled rejection for testing')); });
        clearOverlay && clearOverlay.addEventListener('click', ()=>{ const o = document.getElementById('errorOverlay'); if(o) o.style.display='none'; });

        // Automated test cases (added per instruction)
        function almostEqual(a,b,eps=0.1){ if(isNaN(a) && isNaN(b)) return true; return Math.abs(a-b) <= eps; }
        function runTests(){
          const results = [];
          // Test A: no motion -> f' = f
          (function(){ const f=440, vs=0, vo=0, v=343, modeVal='mendekat'; const actual = computeObservedFrequency(f,v,vo,vs,modeVal); const expected = 440; results.push({name:'No motion', expected, actual, ok: almostEqual(actual, expected)}); })();
          // Test B: observer moves toward 10 m/s -> increases
          (function(){ const f=440, vs=0, vo=10, v=343, modeVal='mendekat'; const actual = computeObservedFrequency(f,v,vo,vs,modeVal); const expected = Math.round((440*((v+10)/v))*100)/100; results.push({name:'Observer 10 m/s toward', expected, actual: Math.round(actual*100)/100, ok: almostEqual(actual, expected,0.5)}); })();
          // Test C: source moves toward 10 m/s -> increases
          (function(){ const f=440, vs=10, vo=0, v=343, modeVal='mendekat'; const actual = computeObservedFrequency(f,v,vo,vs,modeVal); const expected = Math.round((440*(v/(v-10)))*100)/100; results.push({name:'Source 10 m/s toward', expected, actual: Math.round(actual*100)/100, ok: almostEqual(actual, expected,0.5)}); })();
          // Test D: both moving away 10 m/s -> decreases
          (function(){ const f=440, vs=10, vo=10, v=343, modeVal='menjauh'; const actual = computeObservedFrequency(f,v,vo,vs,modeVal); const expected = Math.round((440*((v-10)/(v+10)))*100)/100; results.push({name:'Both 10 m/s away', expected, actual: Math.round(actual*100)/100, ok: almostEqual(actual, expected,0.5)}); })();

          // Show results
          testResults.innerHTML = results.map(r=>`<div>${r.name}: expected=${r.expected}, actual=${r.actual}, ${r.ok?'<strong style="color:green">OK</strong>':'<strong style="color:red">FAIL</strong>'}</div>`).join('');
          return results;
        }

        runTestsBtn && runTestsBtn.addEventListener('click', ()=>{ try{ runTests(); }catch(e){ showErrorOverlay('runTests failed:\n' + stringifySafe(e)); } });

        // initial UI update and compute
        updateDisplays(); computeAndUpdate();

      }catch(e){ showErrorOverlay('Init error:\n' + stringifySafe(e)); }
    });
  </script>
</body>
</html>
